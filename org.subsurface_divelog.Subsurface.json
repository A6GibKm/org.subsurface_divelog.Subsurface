{
	"app-id": "org.subsurface_divelog.Subsurface",
	"runtime": "org.kde.Platform",
	"runtime-version": "5.9",
	"sdk": "org.kde.Sdk",
	"command": "subsurface",
	"rename-icon": "subsurface-icon",
	"rename-appdata-file": "subsurface.appdata.xml",
	"rename-desktop-file": "subsurface.desktop",
	"finish-args":[
		"--socket=x11",
		"--share=network",
		"--filesystem=home",
		"--device=all",
		"--system-talk-name=org.bluez",
		"--env=QTWEBENGINE_DISABLE_SANDBOX=1"
	],
	"build-options": {
		"cflags": "-O2",
		"cxxflags": "-O2"
	},
	"cleanup": [
		"/include",
		"/lib/pkgconfig",
		"/lib64/pkgconfig",
		"/lib/cmake",
		"/share/doc",
		"/share/man",
		"*.a",
		"*.la",
		"*.cmake"
	],
	"modules":[
		{
			"name": "qtwebkit",
			"buildsystem": "simple",
			"cleanup-platform": [
				"/bin",
				"/mkspecs"
			],
			"sources": [
				{
					"type": "archive",
					"url": "https://github.com/qt/qtwebkit/archive/v5.212.0-alpha2.tar.gz",
					"sha256": "6db43b931f64857cfda7bcf89914e2730b82164871a8c24c1881620e6bfdeca1"
				}
			],
			"build-commands": [
				"qmake",
				"grep -rl '/usr/local' . | xargs sed -i 's|/usr/local|/app|g'",
				"make",
				"find . -name \"cmake_install.cmake\" | xargs sed -i 's|/usr|/app|g'",
				"make install"
			]
		},
		"shared-modules/udev/udev-175.json",
		{
			"name": "libical",
			"cleanup": [ "/lib/cmake"],
			"buildsystem": "cmake",
			"config-opts": [ "-DCMAKE_INSTALL_LIBDIR:PATH=/app/lib",
							  "-DBUILD_SHARED_LIBS:BOOL=ON" ],
			"sources": [
				{
					"type": "archive",
					"url": "https://github.com/libical/libical/releases/download/v1.0.1/libical-1.0.1.tar.gz",
					"sha256": "089ce3c42d97fbd7a5d4b3c70adbdd82115dd306349c1f5c46a8fb3f8c949592"
				}
			]
		},
		{
			"name":"libssh2",
			"buildsystem":"cmake",
			"config-opts":[
				"-DCMAKE_INSTALL_LIBDIR=/app/lib",
				"-DCMAKE_C_FLAGS=-fPIC"
			],
			"sources":[
				{
					"type":"archive",
					"url":"https://github.com/libssh2/libssh2/archive/libssh2-1.8.0.tar.gz",
					"sha256": "973f63f98141d68b4a1bc85791ee29411eeab12a6230ae1aca9c368550ccafae"
				}
			]
		},
		{
			"name":"libzip",
			"sources":[
				{
					"type":"archive",
					"url":"https://github.com/nih-at/libzip/archive/rel-1-3-2.tar.gz",
					"sha256": "c900c570bcf3e33c6dfa8c1545e5e4d51a5d8f32bb252d4003cc8bab3df09718"
				},
				{
					"type":"script",
					"commands":["autoreconf -vfi"],
					"dest-filename": "autogen.sh"
				}
			]
		},
		{
			"name": "libdivecomputer",
			"sources": [
				{
					"type":"archive",
					"url":"https://github.com/Subsurface-divelog/libdc/archive/v4.7.4.tar.gz",
					"sha256": "e9cda16de168b2f38436f3a791c947ef2e7436abb00c9125c37049e796835ce6"
				},
				{
					"type": "shell",
					"commands": ["autoreconf --install", "autoreconf --install"]
				}
			]
		},
		{
			"name":"googlemaps",
			"buildsystem": "simple",
			"sources":[
				{
					"type":"git",
					"url":"https://github.com/Subsurface-divelog/googlemaps.git"
				}
			],
			"build-commands": [
				"mkdir build",
				"cd build && \\
				qmake PREFIX=/app ../googlemaps.pro && \\
				sed -i \"s|(INSTALL_ROOT)/usr|//app|\" Makefile && \\
				sed -i 's/std=c++1z/std=c++11/g ; s/-Wdate-time//' Makefile && \\
				make -j4 && \\
				make install"
			]
		},
		{
			"name":"grantlee",
			"buildsystem": "cmake",
			"config-opts": [
				"-DCMAKE_INSTALL_INCLUDEDIR:PATH=/app/include",
				"-DCMAKE_INSTALL_LIBDIR:PATH=/app/lib",
				"-DCMAKE_BUILD_TYPE=Release",
				"-DCMAKE_INSTALL_PREFIX=/app",
				"-DBUILD__TESTS=NO"
			],
			"sources":[
				{
					"type":"archive",
					"url":"https://github.com/steveire/grantlee/archive/v5.1.0.tar.gz",
					"sha256": "3836572fe5e49d28a1d99186c6d96f88ff839644b4bc77b73b6d8208f6ccc9d1"
				}
			]
		},
		{
			"name":"libgit",
			"buildsystem": "cmake",
			"config-opts": [
				"-DCMAKE_INSTALL_INCLUDEDIR:PATH=/app/include",
				"-DCMAKE_INSTALL_LIBDIR:PATH=/app/lib",
				"-DCMAKE_BUILD_TYPE=Release",
				"-DCMAKE_INSTALL_PREFIX=/app",
				"-DBUILD_CLAR=OFF"
			],
			"sources":[
				{
					"type":"archive",
					"url":"https://github.com/libgit2/libgit2/archive/v0.26.0.tar.gz",
					"sha256": "6a62393e0ceb37d02fe0d5707713f504e7acac9006ef33da1e88960bd78b6eac"
				}
			]
		},
        {
			"name": "bluez",
			"config-opts": [ "--disable-datafiles", "--disable-systemd", "--enable-library", "--prefix=/app", "--sysconfdir=/app/etc" ],
			"sources": [
				{
					"type": "archive",
					"url": "http://www.kernel.org/pub/linux/bluetooth/bluez-5.47.tar.xz",
					"sha256": "cf75bf7cd5d564f21cc4a2bd01d5c39ce425397335fd47d9bbe43af0a58342c8"
				},
				{
				  "type": "shell",
				  "commands": ["sed -i \"s|\\${exec_prefix}|/app|g\" /app/share/pkgconfig/udev.pc"]
				}
			]
		},
        {
			"name": "qt5-connectivity",
			"buildsystem": "simple",
			"cleanup-platform": [ "/bin", "/mkspecs" ],
			"sources": [
				{
					"type": "git",
					"url": "git://code.qt.io/qt/qtconnectivity.git",
					"branch": "v5.9.1"
				}
			],
			"build-commands": [
					"qmake",
					"make",
					"cp -r -n bin /app",
					"cp -r -n include /app",
					"cp -r -n lib /app",
					"mkdir -p /app/src/bluetooth",
					"cp -r src/bluetooth /app/src/"
			]
		},
		{
			"name": "subsurface",
			"buildsystem": "cmake",
			"builddir": true,
			"config-opts": [
				"-DCMAKE_BUILD_TYPE=Release",
				"-DSUBSURFACE_TARGET_EXECUTABLE=DesktopExecutable",
				"-DLIBDIVECOMPUTER_INCLUDE_DIR=/app/include",
				"-DLIBDIVECOMPUTER_LIBRARIES=/app/lib/libdivecomputer.a",
				"-DCMAKE_PREFIX_PATH=/app",
				"-DNO_PRINTING=OFF",
				"-DQt5WebKitWidgets_DIR=/app/lib/cmake/Qt5WebKitWidgets"
			],
			"make-args": ["LIBRARY_PATH=/app/lib"],
			"sources":[
				{
					"type":"archive",
					"url": "https://github.com/Subsurface-divelog/subsurface/archive/v4.7.4.tar.gz",
					"sha256": "09a9150263e0411ca70c60794ef6f00a1e2eaffedf61744de2e0eff961e30275"
				},
				{
					"type": "shell",
					"commands": [
						"mkdir -p /app/share/metainfo",
						"cp ./appdata/subsurface.appdata.xml /app/share/metainfo"
					]
				}
			]
		}
	]
}
